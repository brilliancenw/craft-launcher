{% import "_includes/forms" as forms %}

<div id="launcher-table-utility">
    <h2>Launcher Database Status</h2>

    <div class="field">
        <div class="heading">
            <label>User History Table</label>
            <div class="instructions">
                <p>The launcher uses this database table to track user launch history and provide intelligent search suggestions.</p>
            </div>
        </div>
        <div class="input">
            {% if tableStatus.exists %}
                <div class="flex items-center">
                    <span class="status green" data-icon="check"></span>
                    <span>{{ tableStatus.message }}</span>
                </div>

                {% if stats %}
                    <div style="margin-top: 15px;">
                        <h4>Table Statistics</h4>
                        <table class="data">
                            <tbody>
                                <tr>
                                    <th class="light">Total History Records</th>
                                    <td>{{ stats.totalRecords|number_format }}</td>
                                </tr>
                                <tr>
                                    <th class="light">Active Users</th>
                                    <td>{{ stats.totalUsers|number_format }}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                {% endif %}
            {% else %}
                <div class="flex items-center" style="margin-bottom: 15px;">
                    <span class="status red" data-icon="alert"></span>
                    <span>{{ tableStatus.message }}</span>
                </div>

                <div style="padding: 15px; background: #fef2f2; border: 1px solid #fecaca; border-radius: 4px; margin-bottom: 15px;">
                    <h4 style="margin-top: 0; color: #dc2626;">Action Required</h4>
                    <p><strong>The user history table is missing.</strong> This means launch history and popular items won't work properly.</p>

                    <p><strong>Choose one of the following options to fix this:</strong></p>
                    <ul>
                        <li><strong>Option 1:</strong> Use the "Create User History Table" button below</li>
                        <li><strong>Option 2:</strong> Reinstall the plugin: <code>php craft plugin/uninstall launcher && php craft plugin/install launcher</code></li>
                        <li><strong>Option 3:</strong> Run the console command: <code>php craft launcher/default/create-table</code></li>
                    </ul>
                </div>

                <button type="button"
                        class="btn submit"
                        id="create-table-btn"
                        onclick="createLauncherTable()">
                    Create User History Table
                </button>
            {% endif %}
        </div>
    </div>

    <hr>

    <div class="field">
        <div class="heading">
            <label>System Information</label>
        </div>
        <div class="input">
            <table class="data">
                <tbody>
                    <tr>
                        <th class="light" style="width: 30%;">Plugin Version</th>
                        <td>{{ pluginVersion }}</td>
                    </tr>
                    <tr>
                        <th class="light">Craft Version</th>
                        <td>{{ craftVersion }}</td>
                    </tr>
                    <tr>
                        <th class="light">History Tracking</th>
                        <td>
                            {% if settings.enableLaunchHistory %}
                                <span class="status green" data-icon="check"></span> Enabled
                            {% else %}
                                <span class="status" data-icon="minus"></span> Disabled in settings
                            {% endif %}
                        </td>
                    </tr>
                    {% if not tableStatus.exists %}
                    <tr>
                        <th class="light">Impact</th>
                        <td style="color: #dc2626;">
                            Search functionality works normally, but user history and popular items are disabled.
                        </td>
                    </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>

    {% if not tableStatus.exists %}
    <div class="field" style="margin-top: 30px;">
        <div class="heading">
            <label>Advanced Options</label>
        </div>
        <div class="input">
            <p>If the automatic table creation fails, you can try these console commands:</p>
            <div style="background: #f9f9f9; padding: 10px; border-radius: 4px; font-family: monospace;">
                # Check status<br>
                php craft launcher/default/status<br><br>
                # Create table manually<br>
                php craft launcher/default/create-table<br><br>
                # View statistics (after table is created)<br>
                php craft launcher/default/stats
            </div>
        </div>
    </div>
    {% endif %}
</div>

<script>
function createLauncherTable() {
    const btn = document.getElementById('create-table-btn');
    const originalText = btn.textContent;

    btn.disabled = true;
    btn.textContent = 'Creating Table...';

    // Make AJAX request to create the table
    fetch('{{ actionUrl('launcher/utility/create-table') }}', {
        method: 'POST',
        headers: {
            'Accept': 'application/json',
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRF-Token': '{{ craft.app.request.csrfToken }}'
        }
    })
    .then(response => {
        console.log('Response status:', response.status, response.statusText);
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.text(); // Get as text first to debug
    })
    .then(text => {
        console.log('Response text:', text);
        try {
            const data = JSON.parse(text);
            console.log('Parsed response data:', data);
            if (data && data.success) {
                // Reload the utility to show the updated status
                Craft.cp.displayNotice('User history table created successfully!');
                setTimeout(() => location.reload(), 1000); // Small delay to show notice
            } else {
                Craft.cp.displayError(data?.error || 'Failed to create table. Please try the console command.');
                btn.disabled = false;
                btn.textContent = originalText;
            }
        } catch (e) {
            console.error('JSON parse error:', e, 'Raw text:', text);
            Craft.cp.displayError('Invalid response from server. Check the console for details.');
            btn.disabled = false;
            btn.textContent = originalText;
        }
    })
    .catch(error => {
        console.error('Fetch error:', error);
        Craft.cp.displayError('Network error occurred: ' + error.message + '. Please try the console command.');
        btn.disabled = false;
        btn.textContent = originalText;
    });
}
</script>