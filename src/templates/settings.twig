{% import "_includes/forms" as forms %}

{% set isProjectConfigReadOnly = craft.app.projectConfig.readOnly %}

{% if isProjectConfigReadOnly %}
    <div class="readable">
        <blockquote class="note">
            <p><strong>Settings are read-only.</strong></p>
            <p>The system is currently configured to disallow administrative changes. To adjust plugin settings, update your project config files in your development environment and deploy the changes.</p>
        </blockquote>
    </div>
{% endif %}

<h1>General Settings</h1>
<p>Configure how the launcher behaves and responds to user input.</p>

<table class="data fullwidth fixed-layout" dir="ltr">
    <tbody>
        <tr>
            <th class="light" style="width: 30%;">
                <label for="hotkey">Keyboard Shortcut</label>
                <div class="instructions">
                    <small>The keyboard shortcut to open the launcher (e.g., cmd+k, ctrl+shift+p)</small>
                </div>
            </th>
            <td>
                {{ forms.textField({
                    id: 'hotkey',
                    name: 'hotkey',
                    value: settings.hotkey,
                    required: true,
                    placeholder: 'cmd+k',
                    errors: settings.getErrors('hotkey'),
                    disabled: isProjectConfigReadOnly,
                }) }}
            </td>
        </tr>
        <tr>
            <th class="light">
                <label for="debounceDelay">Search Delay</label>
                <div class="instructions">
                    <small>Milliseconds to wait after typing before searching</small>
                </div>
            </th>
            <td>
                {{ forms.textField({
                    id: 'debounceDelay',
                    name: 'debounceDelay',
                    value: settings.debounceDelay,
                    type: 'number',
                    min: 100,
                    max: 1000,
                    placeholder: '300',
                    errors: settings.getErrors('debounceDelay'),
                    disabled: isProjectConfigReadOnly,
                }) }}
            </td>
        </tr>
        <tr>
            <th class="light">
                <label for="maxResults">Maximum Results</label>
                <div class="instructions">
                    <small>Maximum number of results to show for each content type</small>
                </div>
            </th>
            <td>
                {{ forms.textField({
                    id: 'maxResults',
                    name: 'maxResults',
                    value: settings.maxResults,
                    type: 'number',
                    min: 1,
                    max: 50,
                    placeholder: '5',
                    errors: settings.getErrors('maxResults'),
                    disabled: isProjectConfigReadOnly,
                }) }}
            </td>
        </tr>
    </tbody>
</table>

<hr>

<h1>Searchable Content Types</h1>
<p>Choose which types of content should be included in search results.</p>

<table class="data fullwidth fixed-layout" dir="ltr">
    <tbody>
        <tr>
            <th style="width: 25%;">Content Type</th>
            <th style="width: 25%;">Include in Search</th>
            <th>Description</th>
        </tr>
        <tr>
            <th class="light">Entries</th>
            <td>
                {{ forms.lightswitchField({
                    id: 'searchableTypes-entries',
                    name: 'searchableTypes[entries]',
                    on: settings.searchableTypes.entries ?? true,
                    disabled: isProjectConfigReadOnly,
                }) }}
            </td>
            <td class="light">Search all entry content across sections</td>
        </tr>
        <tr>
            <th class="light">Categories</th>
            <td>
                {{ forms.lightswitchField({
                    id: 'searchableTypes-categories',
                    name: 'searchableTypes[categories]',
                    on: settings.searchableTypes.categories ?? true,
                    disabled: isProjectConfigReadOnly,
                }) }}
            </td>
            <td class="light">Search categories from all category groups</td>
        </tr>
        <tr>
            <th class="light">Assets</th>
            <td>
                {{ forms.lightswitchField({
                    id: 'searchableTypes-assets',
                    name: 'searchableTypes[assets]',
                    on: settings.searchableTypes.assets ?? true,
                    disabled: isProjectConfigReadOnly,
                }) }}
            </td>
            <td class="light">Search files and media assets</td>
        </tr>
        <tr>
            <th class="light">Users</th>
            <td>
                {{ forms.lightswitchField({
                    id: 'searchableTypes-users',
                    name: 'searchableTypes[users]',
                    on: settings.searchableTypes.users ?? true,
                    disabled: isProjectConfigReadOnly,
                }) }}
            </td>
            <td class="light">Search user accounts</td>
        </tr>
        <tr>
            <th class="light">Global Sets</th>
            <td>
                {{ forms.lightswitchField({
                    id: 'searchableTypes-globals',
                    name: 'searchableTypes[globals]',
                    on: settings.searchableTypes.globals ?? true,
                    disabled: isProjectConfigReadOnly,
                }) }}
            </td>
            <td class="light">Search global content sets</td>
        </tr>
        <tr>
            <th class="light">Sections</th>
            <td>
                {{ forms.lightswitchField({
                    id: 'searchableTypes-sections',
                    name: 'searchableTypes[sections]',
                    on: settings.searchableTypes.sections ?? true,
                    disabled: isProjectConfigReadOnly,
                }) }}
            </td>
            <td class="light">Navigate to section settings</td>
        </tr>
        <tr>
            <th class="light">Category Groups</th>
            <td>
                {{ forms.lightswitchField({
                    id: 'searchableTypes-categoryGroups',
                    name: 'searchableTypes[categoryGroups]',
                    on: settings.searchableTypes.categoryGroups ?? true,
                    disabled: isProjectConfigReadOnly,
                }) }}
            </td>
            <td class="light">Navigate to category group settings</td>
        </tr>
        <tr>
            <th class="light">Asset Volumes</th>
            <td>
                {{ forms.lightswitchField({
                    id: 'searchableTypes-assetVolumes',
                    name: 'searchableTypes[assetVolumes]',
                    on: settings.searchableTypes.assetVolumes ?? true,
                    disabled: isProjectConfigReadOnly,
                }) }}
            </td>
            <td class="light">Navigate to asset volume settings</td>
        </tr>
        <tr>
            <th class="light">Fields</th>
            <td>
                {{ forms.lightswitchField({
                    id: 'searchableTypes-fields',
                    name: 'searchableTypes[fields]',
                    on: settings.searchableTypes.fields ?? true,
                    disabled: isProjectConfigReadOnly,
                }) }}
            </td>
            <td class="light">Navigate to field definitions</td>
        </tr>
        <tr>
            <th class="light">Field Groups</th>
            <td>
                {{ forms.lightswitchField({
                    id: 'searchableTypes-fieldGroups',
                    name: 'searchableTypes[fieldGroups]',
                    on: settings.searchableTypes.fieldGroups ?? true,
                    disabled: isProjectConfigReadOnly,
                }) }}
            </td>
            <td class="light">Navigate to field group settings</td>
        </tr>
        <tr>
            <th class="light">User Groups</th>
            <td>
                {{ forms.lightswitchField({
                    id: 'searchableTypes-userGroups',
                    name: 'searchableTypes[userGroups]',
                    on: settings.searchableTypes.userGroups ?? true,
                    disabled: isProjectConfigReadOnly,
                }) }}
            </td>
            <td class="light">Navigate to user group settings</td>
        </tr>
        <tr>
            <th class="light">Plugins</th>
            <td>
                {{ forms.lightswitchField({
                    id: 'searchableTypes-plugins',
                    name: 'searchableTypes[plugins]',
                    on: settings.searchableTypes.plugins ?? true,
                    disabled: isProjectConfigReadOnly,
                }) }}
            </td>
            <td class="light">Navigate to plugin settings</td>
        </tr>
        <tr>
            <th class="light">Routes</th>
            <td>
                {{ forms.lightswitchField({
                    id: 'searchableTypes-routes',
                    name: 'searchableTypes[routes]',
                    on: settings.searchableTypes.routes ?? false,
                    disabled: isProjectConfigReadOnly,
                }) }}
            </td>
            <td class="light">Navigate to route settings</td>
        </tr>
    </tbody>
</table>

<hr>

<h1>Search Options</h1>
<p>Configure how the search behaves and what content to include.</p>

<table class="data fullwidth fixed-layout" dir="ltr">
    <tbody>
        <tr>
            <th style="width: 25%;">Option</th>
            <th style="width: 25%;">Enable</th>
            <th>Description</th>
        </tr>
        <tr>
            <th class="light">Include Drafts</th>
            <td>
                {{ forms.lightswitchField({
                    id: 'searchDrafts',
                    name: 'searchDrafts',
                    on: settings.searchDrafts,
                    disabled: isProjectConfigReadOnly,
                }) }}
            </td>
            <td class="light">Include draft entries in search results</td>
        </tr>
        <tr>
            <th class="light">Include Revisions</th>
            <td>
                {{ forms.lightswitchField({
                    id: 'searchRevisions',
                    name: 'searchRevisions',
                    on: settings.searchRevisions,
                    disabled: isProjectConfigReadOnly,
                }) }}
            </td>
            <td class="light">Include entry revisions in search results</td>
        </tr>
        <tr>
            <th class="light">Include Disabled</th>
            <td>
                {{ forms.lightswitchField({
                    id: 'searchDisabled',
                    name: 'searchDisabled',
                    on: settings.searchDisabled,
                    disabled: isProjectConfigReadOnly,
                }) }}
            </td>
            <td class="light">Include disabled elements in search results</td>
        </tr>
        <tr>
            <th class="light">Search Entries by Author</th>
            <td>
                {{ forms.lightswitchField({
                    id: 'searchEntriesByAuthor',
                    name: 'searchEntriesByAuthor',
                    on: settings.searchEntriesByAuthor,
                    disabled: isProjectConfigReadOnly,
                }) }}
            </td>
            <td class="light">When searching for usernames, also show entries authored by those users</td>
        </tr>
    </tbody>
</table>

{% set isCommerceInstalled = craft.app.plugins.isPluginInstalled('commerce') %}
{% if isCommerceInstalled %}
    <hr>
    
    <h1>Commerce Search Options</h1>
    <p>Configure search for Craft Commerce elements (requires Commerce plugin).</p>
    
    <table class="data fullwidth fixed-layout" dir="ltr">
        <tbody>
            <tr>
                <th style="width: 25%;">Option</th>
                <th style="width: 25%;">Enable</th>
                <th>Description</th>
            </tr>
            <tr>
                <th class="light">Search Customers</th>
                <td>
                    {{ forms.lightswitchField({
                        id: 'searchCommerceCustomers',
                        name: 'searchCommerceCustomers',
                        on: settings.searchCommerceCustomers,
                        disabled: isProjectConfigReadOnly,
                    }) }}
                </td>
                <td class="light">Search Commerce customers by name and email</td>
            </tr>
            <tr>
                <th class="light">Search Products</th>
                <td>
                    {{ forms.lightswitchField({
                        id: 'searchCommerceProducts',
                        name: 'searchCommerceProducts',
                        on: settings.searchCommerceProducts,
                        disabled: isProjectConfigReadOnly,
                    }) }}
                </td>
                <td class="light">Search Commerce products and variants by name</td>
            </tr>
            <tr>
                <th class="light">Search Orders</th>
                <td>
                    {{ forms.lightswitchField({
                        id: 'searchCommerceOrders',
                        name: 'searchCommerceOrders',
                        on: settings.searchCommerceOrders,
                        disabled: isProjectConfigReadOnly,
                    }) }}
                </td>
                <td class="light">Search orders by number, customer name, and email</td>
            </tr>
        </tbody>
    </table>
{% endif %}

<hr>

<h1>Result Navigation Shortcuts</h1>
<p>Configure keyboard shortcuts for navigating to search results.</p>

<table class="data fullwidth fixed-layout" dir="ltr">
    <tbody>
        <tr>
            <th class="light" style="width: 30%;">
                <label for="selectResultModifier">Modifier Key</label>
                <div class="instructions">
                    <small>Modifier key used for result selection (cmd, ctrl, alt, shift)</small>
                </div>
            </th>
            <td>
                {{ forms.selectField({
                    id: 'selectResultModifier',
                    name: 'selectResultModifier',
                    value: settings.selectResultModifier,
                    options: [
                        {label: 'Command (⌘)', value: 'cmd'},
                        {label: 'Control (Ctrl)', value: 'ctrl'},
                        {label: 'Alt/Option (⌥)', value: 'alt'},
                        {label: 'Shift (⇧)', value: 'shift'},
                    ],
                    errors: settings.getErrors('selectResultModifier'),
                    disabled: isProjectConfigReadOnly,
                }) }}
            </td>
        </tr>
    </tbody>
</table>

<div class="field">
    <div class="heading">
        <label>Navigation Shortcuts</label>
        <div class="instructions">
            <p>Configure how to activate search results. The first result uses Return key, results 2-10 use the modifier key + number.</p>
            <p><strong>Example:</strong> With "Command" modifier, press Cmd+1 for the first numbered result, Cmd+2 for second, etc.</p>
        </div>
    </div>
    <div class="input">
        <table class="data">
            <thead>
                <tr>
                    <th>Result Position</th>
                    <th>Keyboard Shortcut</th>
                    <th>Icon Display</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><strong>First Result</strong></td>
                    <td><kbd>Return</kbd> / <kbd>Enter</kbd></td>
                    <td>⏎</td>
                </tr>
                <tr>
                    <td>Second Result (#1)</td>
                    <td><kbd>{{ settings.selectResultModifier|capitalize }}+1</kbd></td>
                    <td>{{ settings.selectResultModifier == 'cmd' ? '⌘' : (settings.selectResultModifier|upper) }}+1</td>
                </tr>
                <tr>
                    <td>Third Result (#2)</td>
                    <td><kbd>{{ settings.selectResultModifier|capitalize }}+2</kbd></td>
                    <td>{{ settings.selectResultModifier == 'cmd' ? '⌘' : (settings.selectResultModifier|upper) }}+2</td>
                </tr>
                <tr>
                    <td>Fourth Result (#3)</td>
                    <td><kbd>{{ settings.selectResultModifier|capitalize }}+3</kbd></td>
                    <td>{{ settings.selectResultModifier == 'cmd' ? '⌘' : (settings.selectResultModifier|upper) }}+3</td>
                </tr>
                <tr style="opacity: 0.6;">
                    <td colspan="3"><em>... and so on through {{ settings.selectResultModifier|capitalize }}+9 (up to 10 total results)</em></td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<hr>

<h1>Content Filters</h1>
<p>Optionally limit search to specific sections, categories, or volumes.</p>

{% set allSections = craft.app.entries.getAllSections() %}
{% if allSections|length %}
    {{ forms.checkboxSelectField({
        label: 'Sections to Search',
        instructions: 'Leave blank to search all sections',
        id: 'searchableSections',
        name: 'searchableSections',
        options: allSections|map(s => {label: s.name, value: s.id}),
        values: settings.searchableSections,
        disabled: isProjectConfigReadOnly,
    }) }}
{% endif %}

{% set allCategoryGroups = craft.app.categories.getAllGroups() %}
{% if allCategoryGroups|length %}
    {{ forms.checkboxSelectField({
        label: 'Category Groups to Search',
        instructions: 'Leave blank to search all category groups',
        id: 'searchableCategoryGroups',
        name: 'searchableCategoryGroups',
        options: allCategoryGroups|map(g => {label: g.name, value: g.id}),
        values: settings.searchableCategoryGroups,
        disabled: isProjectConfigReadOnly,
    }) }}
{% endif %}

{% set allAssetVolumes = craft.app.volumes.getAllVolumes() %}
{% if allAssetVolumes|length %}
    {{ forms.checkboxSelectField({
        label: 'Asset Volumes to Search',
        instructions: 'Leave blank to search all volumes',
        id: 'searchableAssetVolumes',
        name: 'searchableAssetVolumes',
        options: allAssetVolumes|map(v => {label: v.name, value: v.id}),
        values: settings.searchableAssetVolumes,
        disabled: isProjectConfigReadOnly,
    }) }}
{% endif %}

<hr>

<h1>System Diagnostics</h1>
<p>Information about the launcher's database setup and functionality.</p>

{% set tableStatus = craft.launcher.history.getTableStatus() %}

<div class="field">
    <div class="heading">
        <label>Database Status</label>
        <div class="instructions">
            <p>The launcher uses a database table to track your launch history and provide intelligent suggestions.</p>
        </div>
    </div>
    <div class="input">
        <table class="data">
            <tbody>
                <tr>
                    <th class="light" style="width: 30%;">User History Table</th>
                    <td>
                        {% if tableStatus.exists %}
                            <span class="status green" data-icon="check"></span> {{ tableStatus.message }}
                        {% else %}
                            <span class="status red" data-icon="alert"></span> {{ tableStatus.message }}

                            <div style="margin-top: 10px; padding: 15px; background: #fef2f2; border: 1px solid #fecaca; border-radius: 4px;">
                                <h4 style="margin-top: 0; color: #dc2626;">Action Required</h4>
                                <p><strong>The user history table is missing.</strong> This means launch history and popular items won't work properly.</p>

                                <p><strong>To fix this issue:</strong></p>
                                <ol>
                                    <li>Try reinstalling the plugin via console:
                                        <code style="display: block; margin: 5px 0; padding: 5px; background: #f9f9f9;">
                                            php craft plugin/uninstall launcher<br>
                                            php craft plugin/install launcher
                                        </code>
                                    </li>
                                    <li>If that doesn't work, contact your developer or system administrator</li>
                                    <li>The plugin will continue to work for searching, but history features will be disabled</li>
                                </ol>
                            </div>
                        {% endif %}
                    </td>
                </tr>
                <tr>
                    <th class="light">Plugin Version</th>
                    <td>{{ craft.app.plugins.getPlugin('launcher').version }}</td>
                </tr>
                <tr>
                    <th class="light">Craft Version</th>
                    <td>{{ craft.app.version }}</td>
                </tr>
                <tr>
                    <th class="light">History Tracking</th>
                    <td>
                        {% if settings.enableLaunchHistory %}
                            <span class="status green" data-icon="check"></span> Enabled
                        {% else %}
                            <span class="status" data-icon="minus"></span> Disabled in settings
                        {% endif %}
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</div>