{% import "_includes/forms" as forms %}

{% set isProjectConfigReadOnly = craft.app.projectConfig.readOnly %}

{# First Run Welcome Screen #}
{% if not settings.firstRunCompleted %}
<div id="settings-launcher-welcome-overlay" class="launcher-welcome-overlay">
    <div class="launcher-welcome-content">
        <div class="launcher-welcome-header">
            <h1>Welcome to Launcher!</h1>
            <div style="position: absolute; top: 10px; right: 10px; background: #ff0000; color: white; padding: 5px 10px; border-radius: 4px; font-size: 12px; font-weight: bold;">
                VERSION: {{ "now"|date("Y-m-d H:i:s") }}
            </div>
        </div>

        <div class="launcher-welcome-message">
            <p class="launcher-welcome-intro">The team at <strong>Brilliance</strong> is thrilled to bring you this powerful search experience!</p>

            <div class="launcher-welcome-features">
                <div class="launcher-welcome-feature">
                    <span class="launcher-welcome-icon">🚀</span>
                    <h3>Lightning-Fast Search</h3>
                    <p>Access everything in Craft with a single keystroke</p>
                </div>
                <div class="launcher-welcome-feature">
                    <span class="launcher-welcome-icon">⚡</span>
                    <h3>Smart & Intuitive</h3>
                    <p>Learns from your usage to show what you need most</p>
                </div>
                <div class="launcher-welcome-feature">
                    <span class="launcher-welcome-icon">💫</span>
                    <h3>Fully Customizable</h3>
                    <p>Configure shortcuts, search types, and more</p>
                </div>
            </div>

            <p class="launcher-welcome-footer">
                We're constantly improving Launcher. Have ideas? Found a bug? We'd love to hear from you!
                <br>
                <a href="https://github.com/brilliancenw/craft-launcher" target="_blank" class="launcher-welcome-link">Share your feedback on GitHub</a>
            </p>
        </div>

        <button type="button" id="settings-launcher-welcome-dismiss" class="btn submit large">Let's Get Started!</button>
    </div>

    <canvas id="settings-launcher-confetti-canvas"></canvas>
</div>

<style>
.launcher-welcome-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(102, 126, 234, 0.15);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    z-index: 10000;
    display: flex;
    align-items: center;
    justify-content: center;
    animation: launcher-fadeIn 0.5s ease-in-out;
}

.launcher-welcome-content {
    background: white;
    border-radius: 16px;
    padding: 60px;
    max-width: 800px;
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
    text-align: center;
    position: relative;
    z-index: 10001;
    animation: launcher-slideUp 0.6s cubic-bezier(0.16, 1, 0.3, 1);
}

.launcher-welcome-header h1 {
    font-size: 48px;
    font-weight: 700;
    color: #667eea;
    margin: 0 0 30px 0;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.launcher-welcome-intro {
    font-size: 20px;
    color: #4a5568;
    margin-bottom: 40px;
    line-height: 1.6;
}

.launcher-welcome-features {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 30px;
    margin: 40px 0;
}

.launcher-welcome-feature {
    text-align: center;
}

.launcher-welcome-icon {
    font-size: 48px;
    display: block;
    margin-bottom: 15px;
    animation: launcher-bounce 2s infinite;
}

.launcher-welcome-feature:nth-child(2) .launcher-welcome-icon {
    animation-delay: 0.2s;
}

.launcher-welcome-feature:nth-child(3) .launcher-welcome-icon {
    animation-delay: 0.4s;
}

.launcher-welcome-feature h3 {
    font-size: 18px;
    font-weight: 600;
    color: #2d3748;
    margin: 0 0 10px 0;
}

.launcher-welcome-feature p {
    font-size: 14px;
    color: #718096;
    margin: 0;
    line-height: 1.5;
}

.launcher-welcome-footer {
    font-size: 16px;
    color: #4a5568;
    margin-top: 40px;
    line-height: 1.6;
}

.launcher-welcome-link {
    color: #667eea;
    font-weight: 600;
    text-decoration: none;
    border-bottom: 2px solid #667eea;
    transition: all 0.2s;
}

.launcher-welcome-link:hover {
    color: #764ba2;
    border-bottom-color: #764ba2;
}

#settings-launcher-welcome-dismiss {
    margin-top: 40px;
    padding: 16px 48px;
    font-size: 18px;
    font-weight: 600;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border: none;
    color: white;
    cursor: pointer;
    transition: transform 0.2s, box-shadow 0.2s;
}

#settings-launcher-welcome-dismiss:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
}

#settings-launcher-confetti-canvas {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    z-index: 10002;
}

@keyframes launcher-fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

@keyframes launcher-slideUp {
    from {
        opacity: 0;
        transform: translateY(40px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

@keyframes launcher-bounce {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-10px); }
}

.launcher-welcome-overlay.launcher-dismissing {
    animation: launcher-fadeOut 0.5s ease-in-out forwards;
}

.launcher-welcome-overlay.launcher-dismissing .launcher-welcome-content {
    animation: launcher-slideDown 0.5s ease-in-out forwards;
}

@keyframes launcher-fadeOut {
    from { opacity: 1; }
    to { opacity: 0; }
}

@keyframes launcher-slideDown {
    from {
        opacity: 1;
        transform: translateY(0);
    }
    to {
        opacity: 0;
        transform: translateY(40px);
    }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded, searching for welcome screen elements...');

    // Craft prefixes IDs with 'settings-' on settings pages
    const overlay = document.getElementById('settings-launcher-welcome-overlay');
    const dismissBtn = document.getElementById('settings-launcher-welcome-dismiss');
    const canvas = document.getElementById('settings-launcher-confetti-canvas');

    console.log('Found elements:', {overlay, dismissBtn, canvas});

    if (!overlay || !dismissBtn || !canvas) {
        console.error('Launcher welcome screen elements not found:', {overlay, dismissBtn, canvas});
        return;
    }

    // Confetti animation
    const ctx = canvas.getContext('2d');
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;

    const confettiPieces = [];
    const confettiCount = 150;
    const colors = ['#667eea', '#764ba2', '#f093fb', '#4facfe', '#43e97b', '#fa709a'];

    class ConfettiPiece {
        constructor() {
            this.x = Math.random() * canvas.width;
            this.y = Math.random() * canvas.height - canvas.height;
            this.size = Math.random() * 8 + 4;
            this.speedY = Math.random() * 3 + 2;
            this.speedX = Math.random() * 2 - 1;
            this.color = colors[Math.floor(Math.random() * colors.length)];
            this.rotation = Math.random() * 360;
            this.rotationSpeed = Math.random() * 10 - 5;
        }

        update() {
            this.y += this.speedY;
            this.x += this.speedX;
            this.rotation += this.rotationSpeed;

            if (this.y > canvas.height) {
                this.y = -10;
                this.x = Math.random() * canvas.width;
            }
        }

        draw() {
            ctx.save();
            ctx.translate(this.x, this.y);
            ctx.rotate(this.rotation * Math.PI / 180);
            ctx.fillStyle = this.color;
            ctx.fillRect(-this.size / 2, -this.size / 2, this.size, this.size);
            ctx.restore();
        }
    }

    // Create confetti pieces
    for (let i = 0; i < confettiCount; i++) {
        confettiPieces.push(new ConfettiPiece());
    }

    // Animation loop
    function animate() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        confettiPieces.forEach(piece => {
            piece.update();
            piece.draw();
        });
        requestAnimationFrame(animate);
    }
    animate();

    // Handle window resize
    window.addEventListener('resize', () => {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
    });

    // Set the flag immediately so it persists on next save
    const hiddenField = document.getElementById('settings-launcher-first-run-field');
    if (hiddenField) {
        hiddenField.value = '1';
        console.log('Set firstRunCompleted flag to 1');
    } else {
        console.error('Hidden field not found');
    }

    // Dismiss button handler
    dismissBtn.addEventListener('click', (e) => {
        console.log('Dismiss button clicked!');
        e.preventDefault();
        e.stopPropagation();
        console.log('Adding dismissing class to overlay');
        overlay.classList.add('launcher-dismissing');
        setTimeout(() => {
            console.log('Removing overlay from DOM');
            overlay.remove();
        }, 500);
    });

    console.log('Welcome screen initialized successfully');
});
</script>
{% endif %}

{# Hidden field to preserve firstRunCompleted setting #}
<input type="hidden" id="settings-launcher-first-run-field" name="settings[firstRunCompleted]" value="{{ settings.firstRunCompleted ? '1' : '' }}">

{# Note: Craft auto-prefixes IDs in settings pages with 'settings-' #}

{% if isProjectConfigReadOnly %}
    <div class="readable">
        <blockquote class="note">
            <p><strong>Settings are read-only.</strong></p>
            <p>The system is currently configured to disallow administrative changes. To adjust plugin settings, update your project config files in your development environment and deploy the changes.</p>
        </blockquote>
    </div>
{% endif %}

<h1>General Settings</h1>
<p>Configure how the launcher behaves and responds to user input.</p>

<table class="data fullwidth fixed-layout" dir="ltr">
    <tbody>
        <tr>
            <th class="light" style="width: 30%;">
                <label for="hotkey">Keyboard Shortcut</label>
                <div class="instructions">
                    <small>The keyboard shortcut to open the launcher (e.g., cmd+k, ctrl+shift+p)</small>
                </div>
            </th>
            <td>
                {{ forms.textField({
                    id: 'hotkey',
                    name: 'hotkey',
                    value: settings.hotkey,
                    required: true,
                    placeholder: 'cmd+k',
                    errors: settings.getErrors('hotkey'),
                    disabled: isProjectConfigReadOnly,
                }) }}
            </td>
        </tr>
        <tr>
            <th class="light">
                <label for="debounceDelay">Search Delay</label>
                <div class="instructions">
                    <small>Milliseconds to wait after typing before searching</small>
                </div>
            </th>
            <td>
                {{ forms.textField({
                    id: 'debounceDelay',
                    name: 'debounceDelay',
                    value: settings.debounceDelay,
                    type: 'number',
                    min: 100,
                    max: 1000,
                    placeholder: '300',
                    errors: settings.getErrors('debounceDelay'),
                    disabled: isProjectConfigReadOnly,
                }) }}
            </td>
        </tr>
        <tr>
            <th class="light">
                <label for="maxResults">Maximum Results</label>
                <div class="instructions">
                    <small>Maximum number of results to show for each content type</small>
                </div>
            </th>
            <td>
                {{ forms.textField({
                    id: 'maxResults',
                    name: 'maxResults',
                    value: settings.maxResults,
                    type: 'number',
                    min: 1,
                    max: 50,
                    placeholder: '5',
                    errors: settings.getErrors('maxResults'),
                    disabled: isProjectConfigReadOnly,
                }) }}
            </td>
        </tr>
    </tbody>
</table>

<hr>

<h1>Searchable Content Types</h1>
<p>Choose which types of content should be included in search results.</p>

<table class="data fullwidth fixed-layout" dir="ltr">
    <tbody>
        <tr>
            <th style="width: 25%;">Content Type</th>
            <th style="width: 25%;">Include in Search</th>
            <th>Description</th>
        </tr>
        <tr>
            <th class="light">Entries</th>
            <td>
                {{ forms.lightswitchField({
                    id: 'searchableTypes-entries',
                    name: 'searchableTypes[entries]',
                    on: settings.searchableTypes.entries ?? true,
                    disabled: isProjectConfigReadOnly,
                }) }}
            </td>
            <td class="light">Search all entry content across sections</td>
        </tr>
        <tr>
            <th class="light">Categories</th>
            <td>
                {{ forms.lightswitchField({
                    id: 'searchableTypes-categories',
                    name: 'searchableTypes[categories]',
                    on: settings.searchableTypes.categories ?? true,
                    disabled: isProjectConfigReadOnly,
                }) }}
            </td>
            <td class="light">Search categories from all category groups</td>
        </tr>
        <tr>
            <th class="light">Assets</th>
            <td>
                {{ forms.lightswitchField({
                    id: 'searchableTypes-assets',
                    name: 'searchableTypes[assets]',
                    on: settings.searchableTypes.assets ?? true,
                    disabled: isProjectConfigReadOnly,
                }) }}
            </td>
            <td class="light">Search files and media assets</td>
        </tr>
        <tr>
            <th class="light">Users</th>
            <td>
                {{ forms.lightswitchField({
                    id: 'searchableTypes-users',
                    name: 'searchableTypes[users]',
                    on: settings.searchableTypes.users ?? true,
                    disabled: isProjectConfigReadOnly,
                }) }}
            </td>
            <td class="light">Search user accounts</td>
        </tr>
        <tr>
            <th class="light">Global Sets</th>
            <td>
                {{ forms.lightswitchField({
                    id: 'searchableTypes-globals',
                    name: 'searchableTypes[globals]',
                    on: settings.searchableTypes.globals ?? true,
                    disabled: isProjectConfigReadOnly,
                }) }}
            </td>
            <td class="light">Search global content sets</td>
        </tr>
        <tr>
            <th class="light">Sections</th>
            <td>
                {{ forms.lightswitchField({
                    id: 'searchableTypes-sections',
                    name: 'searchableTypes[sections]',
                    on: settings.searchableTypes.sections ?? true,
                    disabled: isProjectConfigReadOnly,
                }) }}
            </td>
            <td class="light">Navigate to section settings</td>
        </tr>
        <tr>
            <th class="light">Category Groups</th>
            <td>
                {{ forms.lightswitchField({
                    id: 'searchableTypes-categoryGroups',
                    name: 'searchableTypes[categoryGroups]',
                    on: settings.searchableTypes.categoryGroups ?? true,
                    disabled: isProjectConfigReadOnly,
                }) }}
            </td>
            <td class="light">Navigate to category group settings</td>
        </tr>
        <tr>
            <th class="light">Asset Volumes</th>
            <td>
                {{ forms.lightswitchField({
                    id: 'searchableTypes-assetVolumes',
                    name: 'searchableTypes[assetVolumes]',
                    on: settings.searchableTypes.assetVolumes ?? true,
                    disabled: isProjectConfigReadOnly,
                }) }}
            </td>
            <td class="light">Navigate to asset volume settings</td>
        </tr>
        <tr>
            <th class="light">Fields</th>
            <td>
                {{ forms.lightswitchField({
                    id: 'searchableTypes-fields',
                    name: 'searchableTypes[fields]',
                    on: settings.searchableTypes.fields ?? true,
                    disabled: isProjectConfigReadOnly,
                }) }}
            </td>
            <td class="light">Navigate to field definitions</td>
        </tr>
        <tr>
            <th class="light">Field Groups</th>
            <td>
                {{ forms.lightswitchField({
                    id: 'searchableTypes-fieldGroups',
                    name: 'searchableTypes[fieldGroups]',
                    on: settings.searchableTypes.fieldGroups ?? true,
                    disabled: isProjectConfigReadOnly,
                }) }}
            </td>
            <td class="light">Navigate to field group settings</td>
        </tr>
        <tr>
            <th class="light">User Groups</th>
            <td>
                {{ forms.lightswitchField({
                    id: 'searchableTypes-userGroups',
                    name: 'searchableTypes[userGroups]',
                    on: settings.searchableTypes.userGroups ?? true,
                    disabled: isProjectConfigReadOnly,
                }) }}
            </td>
            <td class="light">Navigate to user group settings</td>
        </tr>
        <tr>
            <th class="light">Plugins</th>
            <td>
                {{ forms.lightswitchField({
                    id: 'searchableTypes-plugins',
                    name: 'searchableTypes[plugins]',
                    on: settings.searchableTypes.plugins ?? true,
                    disabled: isProjectConfigReadOnly,
                }) }}
            </td>
            <td class="light">Navigate to plugin settings</td>
        </tr>
        <tr>
            <th class="light">Routes</th>
            <td>
                {{ forms.lightswitchField({
                    id: 'searchableTypes-routes',
                    name: 'searchableTypes[routes]',
                    on: settings.searchableTypes.routes ?? false,
                    disabled: isProjectConfigReadOnly,
                }) }}
            </td>
            <td class="light">Navigate to route settings</td>
        </tr>
    </tbody>
</table>

<hr>

<h1>Search Options</h1>
<p>Configure how the search behaves and what content to include.</p>

<table class="data fullwidth fixed-layout" dir="ltr">
    <tbody>
        <tr>
            <th style="width: 25%;">Option</th>
            <th style="width: 25%;">Enable</th>
            <th>Description</th>
        </tr>
        <tr>
            <th class="light">Include Drafts</th>
            <td>
                {{ forms.lightswitchField({
                    id: 'searchDrafts',
                    name: 'searchDrafts',
                    on: settings.searchDrafts,
                    disabled: isProjectConfigReadOnly,
                }) }}
            </td>
            <td class="light">Include draft entries in search results</td>
        </tr>
        <tr>
            <th class="light">Include Revisions</th>
            <td>
                {{ forms.lightswitchField({
                    id: 'searchRevisions',
                    name: 'searchRevisions',
                    on: settings.searchRevisions,
                    disabled: isProjectConfigReadOnly,
                }) }}
            </td>
            <td class="light">Include entry revisions in search results</td>
        </tr>
        <tr>
            <th class="light">Include Disabled</th>
            <td>
                {{ forms.lightswitchField({
                    id: 'searchDisabled',
                    name: 'searchDisabled',
                    on: settings.searchDisabled,
                    disabled: isProjectConfigReadOnly,
                }) }}
            </td>
            <td class="light">Include disabled elements in search results</td>
        </tr>
        <tr>
            <th class="light">Search Entries by Author</th>
            <td>
                {{ forms.lightswitchField({
                    id: 'searchEntriesByAuthor',
                    name: 'searchEntriesByAuthor',
                    on: settings.searchEntriesByAuthor,
                    disabled: isProjectConfigReadOnly,
                }) }}
            </td>
            <td class="light">When searching for usernames, also show entries authored by those users</td>
        </tr>
    </tbody>
</table>

{% set isCommerceInstalled = craft.app.plugins.isPluginInstalled('commerce') %}
{% if isCommerceInstalled %}
    <hr>
    
    <h1>Commerce Search Options</h1>
    <p>Configure search for Craft Commerce elements (requires Commerce plugin).</p>
    
    <table class="data fullwidth fixed-layout" dir="ltr">
        <tbody>
            <tr>
                <th style="width: 25%;">Option</th>
                <th style="width: 25%;">Enable</th>
                <th>Description</th>
            </tr>
            <tr>
                <th class="light">Search Customers</th>
                <td>
                    {{ forms.lightswitchField({
                        id: 'searchCommerceCustomers',
                        name: 'searchCommerceCustomers',
                        on: settings.searchCommerceCustomers,
                        disabled: isProjectConfigReadOnly,
                    }) }}
                </td>
                <td class="light">Search Commerce customers by name and email</td>
            </tr>
            <tr>
                <th class="light">Search Products</th>
                <td>
                    {{ forms.lightswitchField({
                        id: 'searchCommerceProducts',
                        name: 'searchCommerceProducts',
                        on: settings.searchCommerceProducts,
                        disabled: isProjectConfigReadOnly,
                    }) }}
                </td>
                <td class="light">Search Commerce products and variants by name</td>
            </tr>
            <tr>
                <th class="light">Search Orders</th>
                <td>
                    {{ forms.lightswitchField({
                        id: 'searchCommerceOrders',
                        name: 'searchCommerceOrders',
                        on: settings.searchCommerceOrders,
                        disabled: isProjectConfigReadOnly,
                    }) }}
                </td>
                <td class="light">Search orders by number, customer name, and email</td>
            </tr>
        </tbody>
    </table>
{% endif %}

<hr>

<h1>Result Navigation Shortcuts</h1>
<p>Configure keyboard shortcuts for navigating to search results.</p>

<table class="data fullwidth fixed-layout" dir="ltr">
    <tbody>
        <tr>
            <th class="light" style="width: 30%;">
                <label for="selectResultModifier">Modifier Key</label>
                <div class="instructions">
                    <small>Modifier key used for result selection (cmd, ctrl, alt, shift)</small>
                </div>
            </th>
            <td>
                {{ forms.selectField({
                    id: 'selectResultModifier',
                    name: 'selectResultModifier',
                    value: settings.selectResultModifier,
                    options: [
                        {label: 'Command (⌘)', value: 'cmd'},
                        {label: 'Control (Ctrl)', value: 'ctrl'},
                        {label: 'Alt/Option (⌥)', value: 'alt'},
                        {label: 'Shift (⇧)', value: 'shift'},
                    ],
                    errors: settings.getErrors('selectResultModifier'),
                    disabled: isProjectConfigReadOnly,
                }) }}
            </td>
        </tr>
    </tbody>
</table>

<div class="field">
    <div class="heading">
        <label>Navigation Shortcuts</label>
        <div class="instructions">
            <p>Configure how to activate search results. The first result uses Return key, results 2-10 use the modifier key + number.</p>
            <p><strong>Example:</strong> With "Command" modifier, press Cmd+1 for the first numbered result, Cmd+2 for second, etc.</p>
        </div>
    </div>
    <div class="input">
        <table class="data">
            <thead>
                <tr>
                    <th>Result Position</th>
                    <th>Keyboard Shortcut</th>
                    <th>Icon Display</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><strong>First Result</strong></td>
                    <td><kbd>Return</kbd> / <kbd>Enter</kbd></td>
                    <td>⏎</td>
                </tr>
                <tr>
                    <td>Second Result (#1)</td>
                    <td><kbd>{{ settings.selectResultModifier|capitalize }}+1</kbd></td>
                    <td>{{ settings.selectResultModifier == 'cmd' ? '⌘' : (settings.selectResultModifier|upper) }}+1</td>
                </tr>
                <tr>
                    <td>Third Result (#2)</td>
                    <td><kbd>{{ settings.selectResultModifier|capitalize }}+2</kbd></td>
                    <td>{{ settings.selectResultModifier == 'cmd' ? '⌘' : (settings.selectResultModifier|upper) }}+2</td>
                </tr>
                <tr>
                    <td>Fourth Result (#3)</td>
                    <td><kbd>{{ settings.selectResultModifier|capitalize }}+3</kbd></td>
                    <td>{{ settings.selectResultModifier == 'cmd' ? '⌘' : (settings.selectResultModifier|upper) }}+3</td>
                </tr>
                <tr style="opacity: 0.6;">
                    <td colspan="3"><em>... and so on through {{ settings.selectResultModifier|capitalize }}+9 (up to 10 total results)</em></td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<hr>

<h1>Content Filters</h1>
<p>Optionally limit search to specific sections, categories, or volumes.</p>

{% set allSections = craft.app.entries.getAllSections() %}
{% if allSections|length %}
    {{ forms.checkboxSelectField({
        label: 'Sections to Search',
        instructions: 'Leave blank to search all sections',
        id: 'searchableSections',
        name: 'searchableSections',
        options: allSections|map(s => {label: s.name, value: s.id}),
        values: settings.searchableSections,
        disabled: isProjectConfigReadOnly,
    }) }}
{% endif %}

{% set allCategoryGroups = craft.app.categories.getAllGroups() %}
{% if allCategoryGroups|length %}
    {{ forms.checkboxSelectField({
        label: 'Category Groups to Search',
        instructions: 'Leave blank to search all category groups',
        id: 'searchableCategoryGroups',
        name: 'searchableCategoryGroups',
        options: allCategoryGroups|map(g => {label: g.name, value: g.id}),
        values: settings.searchableCategoryGroups,
        disabled: isProjectConfigReadOnly,
    }) }}
{% endif %}

{% set allAssetVolumes = craft.app.volumes.getAllVolumes() %}
{% if allAssetVolumes|length %}
    {{ forms.checkboxSelectField({
        label: 'Asset Volumes to Search',
        instructions: 'Leave blank to search all volumes',
        id: 'searchableAssetVolumes',
        name: 'searchableAssetVolumes',
        options: allAssetVolumes|map(v => {label: v.name, value: v.id}),
        values: settings.searchableAssetVolumes,
        disabled: isProjectConfigReadOnly,
    }) }}
{% endif %}

<hr>

<h1>System Diagnostics</h1>
<p>Information about the launcher's database setup and functionality.</p>

{% set tableStatus = craft.launcher.history.getTableStatus() %}

<div class="field">
    <div class="heading">
        <label>Database Status</label>
        <div class="instructions">
            <p>The launcher uses a database table to track your launch history and provide intelligent suggestions.</p>
        </div>
    </div>
    <div class="input">
        <table class="data">
            <tbody>
                <tr>
                    <th class="light" style="width: 30%;">User History Table</th>
                    <td>
                        {% if tableStatus.exists %}
                            <span class="status green" data-icon="check"></span> {{ tableStatus.message }}
                        {% else %}
                            <span class="status red" data-icon="alert"></span> {{ tableStatus.message }}

                            <div style="margin-top: 10px; padding: 15px; background: #fef2f2; border: 1px solid #fecaca; border-radius: 4px;">
                                <h4 style="margin-top: 0; color: #dc2626;">Action Required</h4>
                                <p><strong>The user history table is missing.</strong> This means launch history and popular items won't work properly.</p>

                                <p><strong>To fix this issue:</strong></p>
                                <div style="margin: 15px 0;">
                                    <a href="{{ url('utilities/launcher-table-manager') }}" class="btn submit">
                                        Go to Launcher Utility to Create Table
                                    </a>
                                </div>

                                <p style="margin-top: 15px;"><strong>Alternative method:</strong> Reinstall the plugin via console:</p>
                                <code style="display: block; margin: 5px 0; padding: 5px; background: #f9f9f9;">
                                    php craft plugin/uninstall launcher<br>
                                    php craft plugin/install launcher
                                </code>

                                <p style="margin-top: 10px; font-size: 0.9em; color: #666;">
                                    <strong>Note:</strong> The plugin will continue to work for searching, but history features will be disabled until the table is created.
                                </p>
                            </div>
                        {% endif %}
                    </td>
                </tr>
                <tr>
                    <th class="light">Plugin Version</th>
                    <td>{{ craft.app.plugins.getPlugin('launcher').version }}</td>
                </tr>
                <tr>
                    <th class="light">Craft Version</th>
                    <td>{{ craft.app.version }}</td>
                </tr>
                <tr>
                    <th class="light">History Tracking</th>
                    <td>
                        {% if settings.enableLaunchHistory %}
                            <span class="status green" data-icon="check"></span> Enabled
                        {% else %}
                            <span class="status" data-icon="minus"></span> Disabled in settings
                        {% endif %}
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</div>